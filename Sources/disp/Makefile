#################################################################
# File Name: Makefile                                           #
# Author: Ganesh Shanubhogue                                    #
# Last Modified: 10-Feb-2020                                    #
#                                                               #
# Copyright: (c) 2019 ExaLeap Semiconductors.                   #
# ExaLeap Proprietary and Confidential. All rights reserved.    #
#################################################################

# Compiler
CC = gcc

# GCC flags
ADD_FLAGS += -g -Wall -Werror -Wno-uninitialized -Wno-unused-function

# Common source directory for the test
TEST_COM_SRC_DIR = ../common

# Libraries used for the testing
INC_LIBS += -ldl -lrt -lpthread -lm

# Include path
INC_PATH += -I. -I$(TEST_COM_SRC_DIR)

# Test source files
TEST_SRCS += $(TEST_COM_SRC_DIR)/test_common.c \
			 ./test_uart_common.c \
			 ./test_uart_main.c

# Temporary files generated by the test
TEST_TEMP_FILES = .test_case_report \
				  .test_suite_report

# Test python file
TEST_PY_FILE = ./test_uart.py

# IP validation main entry file
TEST_MAIN_ENTRY_DIR = ..
TEST_MAIN_ENTRY_FILE = ip_validate.sh

# Binary file directory
TEST_BIN_DIR = bin

# Test binary file
TEST_BIN_FILE = test_uart

# Installation directory
TEST_OUTPUT_DIR = ../output

# Temporay output directory
TEMP_OUTPUT_DIR = .temp_output

# IP directory name
TEST_IP_DIR = uart

# Time string
TEST_TIME_STR = $(shell date +%Y%m%d_%H%M%S)

# Create the required directories if doesnot exists
$(shell mkdir -p $(TEST_BIN_DIR))
$(shell mkdir -p $(TEST_OUTPUT_DIR))

all:
	$(CC) $(TEST_SRCS) $(INC_PATH) -o $(TEST_BIN_DIR)/$(TEST_BIN_FILE) $(INC_LIBS) $(ADD_FLAGS)

install:
	mkdir -p $(TEMP_OUTPUT_DIR)/$(TEST_IP_DIR)/$(TEST_BIN_DIR)
	cp -a $(TEST_MAIN_ENTRY_DIR)/$(TEST_MAIN_ENTRY_FILE) $(TEMP_OUTPUT_DIR)
	cp -a $(TEST_PY_FILE) $(TEMP_OUTPUT_DIR)/$(TEST_IP_DIR)
	cp -a $(TEST_BIN_DIR)/$(TEST_BIN_FILE) $(TEMP_OUTPUT_DIR)/$(TEST_IP_DIR)/$(TEST_BIN_DIR)
	tar cvfz $(TEST_IP_DIR)_test_$(TEST_TIME_STR).tgz -C $(TEMP_OUTPUT_DIR) $(TEST_MAIN_ENTRY_FILE) $(TEST_IP_DIR)
	mv $(TEST_IP_DIR)_test_$(TEST_TIME_STR).tgz $(TEST_OUTPUT_DIR)
	rm -rf $(TEMP_OUTPUT_DIR)

clean:
	rm -f $(TEST_BIN_DIR)/$(TEST_BIN_FILE)
	rm -f $(TEST_IP_DIR)_test*.tgz
	rm -rf $(TEMP_OUTPUT_DIR)
	rm -rf $(TEST_COM_SRC_DIR)/__pycache__
	rm -f $(TEST_TEMP_FILES)

